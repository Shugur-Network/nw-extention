<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Nostr Web Sandbox</title>
    <!-- Permissive CSP for user content - this sandbox is isolated -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; img-src * data: blob:;"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, sans-serif;
      }
    </style>
  </head>
  <body>
    <script>
      /**
       * Sandboxed page for rendering Nostr Web content
       * Chrome sandbox pages (declared in manifest) allow inline scripts
       */

      // Store our message handler in a closure
      const handleMessage = (event) => {
        // Security: Validate origin is our extension
        // Note: In Chrome's sandboxed pages, chrome.runtime is not available
        // We validate by checking if origin matches chrome-extension:// protocol
        if (!event.origin.startsWith("chrome-extension://")) {
          console.warn("Ignoring message from invalid origin:", event.origin);
          return;
        }

        const { cmd, html } = event.data;

        if (cmd === "render") {
          console.log(
            `ðŸ“¥ Sandbox received render command, HTML length: ${
              html?.length || 0
            }`
          );

          try {
            // Inject permissive CSP meta tag into HTML for user content
            // This allows inline scripts and styles in the rendered content
            let modifiedHtml = html;

            // Check if HTML has a <head> tag
            const headMatch = modifiedHtml.match(/<head[^>]*>/i);
            if (headMatch) {
              // Insert CSP meta tag right after opening <head>
              const permissiveCSP = `<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; img-src * data: blob:;">`;
              modifiedHtml = modifiedHtml.replace(
                headMatch[0],
                headMatch[0] + permissiveCSP
              );
            } else {
              // No <head> tag, wrap content with minimal HTML structure
              modifiedHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; img-src * data: blob:;"></head><body>${modifiedHtml}</body></html>`;
            }

            // Use document.write to render HTML with full CSS/JS support
            document.open();
            document.write(modifiedHtml);
            document.close();

            // Re-attach THIS message listener after document.write
            window.addEventListener("message", handleMessage);

            // Notify parent that rendering succeeded
            window.parent.postMessage({ cmd: "renderSuccess" }, "*");
          } catch (error) {
            console.error("Render error:", error);

            // Show error
            document.body.innerHTML = `
              <div style="padding: 40px; font-family: system-ui; color: #e45757;">
                <h1>Render Error</h1>
                <pre style="background: #f5f5f5; padding: 20px; border-radius: 8px; overflow: auto; color: #333;">${
                  error.stack || error
                }</pre>
              </div>
            `;

            // Notify parent of error
            window.parent.postMessage(
              {
                cmd: "renderError",
                error: error.message,
              },
              "*"
            );
          }
        }
      };

      // Attach message listener
      window.addEventListener("message", handleMessage);

      // Signal ready
      window.parent.postMessage({ cmd: "sandboxReady" }, "*");
    </script>
  </body>
</html>
